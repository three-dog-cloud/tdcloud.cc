import{_ as Z,a as J,b as Q,c as V,d as X,e as Y,f as L,g as C}from"./hbcvasLE.js";import{_ as ee,a as te,b as ae,c as se,d as ne,e as le}from"./CZSQlQCv.js";import{g as K,r as h,a4 as v,a5 as O,a6 as o,ab as n,a7 as s,aa as r,ad as g,l as R,aA as oe,x as D,aq as z,ae as x,ar as P,ag as b,ac as U,H as F,Z as re,a2 as ie,k as y,o as ue}from"./assets/index-BE9XhI5F.js";import{O as w,I as de}from"./Cd_E4zi1.js";import{_ as ce,O as T,i as W,a as me,P as _e}from"./Dhes7gQn.js";import{_ as j}from"./C7X8NInV.js";import{a as M,b as N,c as A,_ as E}from"./CEBeazy6.js";import{_ as fe,a as pe,d as ve,c as ge}from"./DH7Y8DHm.js";import{_ as q}from"./Bj6-l3Qo.js";import{_ as k}from"./CUIF3cD1.js";import{_ as B}from"./DAvAWswm.js";import{P as ye}from"./DRO8VUZ_.js";import"./BWDXiyOw.js";import{u as xe}from"./Clxn1Ass.js";import"./CRlC_2N-.js";import"./_f2tVtFK.js";import"./Cvr482_B.js";const G=e=>{e.length>0&&(navigator.clipboard.writeText(e),w.success("复制成功"))},he=K({__name:"data-row-actions",setup(e){const l=h(!1),u=d=>{l.value=d};return(d,a)=>{const i=te;return v(),O(s(ve),{open:l.value,"onUpdate:open":[a[0]||(a[0]=_=>l.value=_),u]},{default:o(()=>[n(s(fe),{"as-child":""},{default:o(()=>[n(s(B),{variant:"ghost",class:"flex h-8 w-8 p-0 data-[state=open]:bg-muted"},{default:o(()=>[n(i,{class:"h-4 w-4"}),a[1]||(a[1]=r("span",{class:"sr-only"},"Open menu",-1))]),_:1})]),_:1}),n(s(pe),{align:"end",class:"w-[160px]"},{default:o(()=>[n(s(ee),null,{default:o(()=>a[2]||(a[2]=[g("操作")])),_:1}),R(d.$slots,"default")]),_:3})]),_:3},8,["open"])}}}),$e=K({__name:"TextOverFlow",props:oe({text:{type:String,required:!0},width:{type:Number,default:30}},{width:8}),setup(e){const l=D(()=>e.width-4),u=D(()=>e.width-8);return(d,a)=>{const i=j;return v(),O(s(E),null,{default:o(()=>[n(s(M),null,{default:o(()=>[n(s(N),null,{default:o(()=>[R(d.$slots,"trigger",{},()=>[r("div",{class:z([`w-${u.value}`,`lg:w-${l.value}`,`xl:w-${e.width}`,"flex items-center gap-4"])},[r("span",{class:z(["text-ellipsis overflow-hidden",[`w-${e.width/2}`,`lg:w-${e.width}`]])},x(e.text),3),e.text.length>0?(v(),O(i,{key:0,class:"size-4 hover:text-gray-500 cursor-pointer",onClick:a[0]||(a[0]=_=>s(G)(e.text))})):P("",!0)],2)])]),_:3}),n(s(A),{class:"text-lg"},{default:o(()=>[R(d.$slots,"content",{},()=>[g(x(e.text),1)])]),_:3})]),_:3})]),_:3})}}}),we={class:"text-xs"},be={key:0,class:"text-xs text-red"},ke={class:"space-y-1 text-center"},Oe={class:"text-sm font-medium leading-none gap-2 space-x-2 flex justify-center items-center"},Pe={class:"container space-y-4"},Ce={key:0,class:"justify-center text-center text-xl font-bold"},Ie={key:1,class:"justify-center text-center font-bold"},Te={class:"text-xs text-yellow-400"},Se={class:"grid grid-cols-2 justify-items-center text-center"},Re={class:"space-y-2"},De={class:"text-sm text-muted-foreground"},Ke={class:"space-y-1"},Ue={class:"text-sm text-muted-foreground"},qe={key:1},ze={class:"space-y-2"},Be={class:"text-sm text-muted-foreground"},Fe={class:"space-y-1"},Ve={class:"text-sm text-muted-foreground"},We={key:1},je={class:"space-y-2"},Me={class:"text-sm text-muted-foreground"},Ne={class:"space-y-1"},Ae={class:"text-sm text-muted-foreground"},Ee={key:1},Ge={class:"space-y-2"},He={class:"text-sm text-muted-foreground"},Ze={class:"space-y-1"},Je={class:"text-sm text-muted-foreground"},Qe=K({__name:"OrderDetailCompent",props:{loading:{type:Boolean},order:{},payments:{},open:{type:Boolean}},emits:["update:setOpen","update:cancelRecord","update:payRecord"],setup(e,{emit:l}){const u=e,d=l,a=D(()=>u.order.original),i=h(0),_=h("");return(c,t)=>{const m=j,f=se;return v(),O(s(he),null,{default:o(()=>[n(s(Z),{open:u.open,"onUpdate:open":t[6]||(t[6]=p=>{u.loading||d("update:setOpen",p)})},{default:o(()=>[n(s(J),null,{default:o(()=>[n(s(ge),{onSelect:t[0]||(t[0]=p=>p.preventDefault())},{default:o(()=>t[7]||(t[7]=[g(" 查看 ")])),_:1})]),_:1}),n(s(Q),null,{default:o(()=>[n(s(V),{loading:c.loading??!1},{default:o(()=>[n(s(X),null,{default:o(()=>[n(s(Y),{class:"flex space-x-2"},{default:o(()=>[t[8]||(t[8]=r("span",null," 订单详情 ",-1)),r("div",we,"更新时间 "+x(a.value.updated_at),1)]),_:1}),n(s(L),{class:"items-center text-center"},{default:o(()=>[r("div",{class:z(["inline-block rounded-lg my-2 p-3 bg-gray-100 dark:bg-muted/50 font-bold",[a.value.status==4?"text-green!":"",a.value.status==2?"text-red!":"",a.value.status==3?"text-yellow":""]])},[g(x(a.value.status_label)+" ",1),a.value.status!=0&&!a.value.is_auto?(v(),b("p",be," 购买商品非自动处理商品，请耐心等待处理结果 ")):P("",!0)],2),r("div",ke,[r("h3",Oe,[g(" 订单号："+x(a.value.order_no)+" ",1),n(m,{class:"h-4 w-4 hover:text-gray-500 cursor-pointer",onClick:t[1]||(t[1]=p=>s(G)(a.value.order_no))})]),t[9]||(t[9]=r("h4",{class:"text-sm font-medium leading-none color-indigo-400"},"Thank you!",-1)),t[10]||(t[10]=r("p",{class:"text-sm text-muted-foreground"},"如果您有任何疑问，请联系我们。",-1))])]),_:1})]),_:1}),r("div",Pe,[n(s(q),{class:"my-1"}),a.value.title.length>0?(v(),b("div",Ce," 订单信息："+x(a.value.title),1)):P("",!0),a.value.gd_no&&a.value.gd_no.length>0?(v(),b("div",Ie,[t[11]||(t[11]=g(" 商品编号：")),r("span",Te,x(a.value.gd_no),1)])):P("",!0),r("div",Se,[r("div",Re,[n(s(k),{class:"text-lg font-medium"},{default:o(()=>t[12]||(t[12]=[g("订单类型")])),_:1}),r("div",De,x(a.value.order_type_label),1)]),r("div",Ke,[n(s(k),{class:"text-lg font-medium"},{default:o(()=>t[13]||(t[13]=[g("商品金额")])),_:1}),r("div",Ue,[a.value.total_amount>0?(v(),O(U(s(C)(a.value.total_amount)),{key:0})):(v(),b("span",qe,x("-")))])]),r("div",ze,[n(s(k),{class:"text-lg font-medium"},{default:o(()=>t[14]||(t[14]=[g("创建时间")])),_:1}),r("div",Be,x(a.value.created_at),1)]),r("div",Fe,[n(s(k),{class:"text-lg font-medium flex items-center cursor-pointer"},{default:o(()=>[t[16]||(t[16]=g(" 手续费 ")),n(s(E),null,{default:o(()=>[n(s(M),null,{default:o(()=>[n(s(N),{"as-child":""},{default:o(()=>[n(f,{class:"ml-1 size-4 color-red-600"})]),_:1}),n(s(A),null,{default:o(()=>t[15]||(t[15]=[r("p",null,"平台收取交易手续费",-1)])),_:1})]),_:1})]),_:1})]),_:1}),r("div",Ve,[a.value.handling_amount>0?(v(),O(U(s(C)(a.value.handling_amount)),{key:0})):(v(),b("span",We,"无手续费"))])]),r("div",je,[n(s(k),{class:"text-lg font-medium"},{default:o(()=>t[17]||(t[17]=[g("付款时间")])),_:1}),r("div",Me,x(a.value.paid_time??"-"),1)]),r("div",Ne,[n(s(k),{class:"text-lg font-medium"},{default:o(()=>t[18]||(t[18]=[g("优惠金额")])),_:1}),r("div",Ae,[a.value.discount_amount>0?(v(),O(U(s(C)(a.value.discount_amount)),{key:0})):(v(),b("span",Ee,"无优惠"))])]),r("div",Ge,[n(s(k),{class:"text-lg font-medium"},{default:o(()=>t[19]||(t[19]=[g("支付方式")])),_:1}),r("div",He,x(a.value.payment_name.length>0?a.value.payment_name:"-"),1)]),r("div",Ze,[n(s(k),{class:"text-lg font-medium"},{default:o(()=>t[20]||(t[20]=[g("购买数量")])),_:1}),r("div",Je,x(a.value.quantity),1)])])]),a.value.status<2?(v(),b(F,{key:0},[a.value.status==0?(v(),b(F,{key:0},[n(s(q),{class:"my-2"}),R(c.$slots,"pay-slot",{},()=>[n(s(ce),{oldPayment:"",payments:u.payments,price:a.value.total_amount,loading:c.loading??!1,payment:_.value,"onOnUpdate:payment":t[2]||(t[2]=p=>{_.value=p}),"onOnUpdate:price":t[3]||(t[3]=p=>{i.value=p})},null,8,["payments","price","loading","payment"])])],64)):P("",!0),n(s(q),{class:"my-2"}),n(s(ae),null,{default:o(()=>[a.value.status==0?(v(),O(s(B),{key:0,variant:"outline",onClick:t[4]||(t[4]=p=>d("update:cancelRecord",u.order.index))},{default:o(()=>t[21]||(t[21]=[g(" 取消 ")])),_:1})):P("",!0),n(s(B),{onClick:t[5]||(t[5]=p=>d("update:payRecord",u.order.index,_.value))},{default:o(()=>[g(x(a.value.status!=0&&a.value.is_auto?"重试":"支付"),1)]),_:1})]),_:1})],64)):P("",!0)]),_:3},8,["loading"])]),_:3})]),_:3},8,["open"])]),_:3})}}}),$=h([]),Xe=(e,l)=>{const u=h(!1),d=h(-1),a=h(-1),i=h(null),_=h(),c=D(()=>{const{pageSize:t,pageIndex:m}=e.value,f=m+1;return{...l.value.value,limit:t,page:f}});return re(()=>{u.value=!0,i.value=T.getOrders(c.value).then(t=>{t.items&&($.value=t.items),t.filter&&(_.value=t.filter),d.value=Math.ceil(t.total/t.limit),a.value=t.total}).catch(t=>{w.error(t.error)}).finally(()=>u.value=!1)}),{loading:u,filter:_,tableData:$,totalResultCount:d,totalResultCountTotal:a}};async function Ye(e,l,u){const d=(a,i)=>new Promise((_,c)=>{const t=setInterval(()=>{T.getOrderStatus(a).then(f=>{f.status>1&&(clearInterval(t),clearInterval(m),_(f))}).catch(f=>{clearInterval(t),clearTimeout(m),c(f)})},4e3),m=setInterval(()=>{i-=1,i<=0&&(clearInterval(t),clearInterval(m),c({error:"等待超时，请联系管理员操作",code:-408}))},1e3)});return l.value=!0,T.continueProcessOrder(e).then(a=>{w.promise(()=>(setTimeout(()=>{let i=a.redirect;W(i)||(i=`${window.location.origin}`+i,console.log(i)),window.open(i,"_blank")},2e3),d(e,360)),{loading:"请在新打开的页面等待处理结果，请勿关闭页面......",success:i=>(setTimeout(()=>{u()},3e3),i.status==3?"处理成功":"处理失败"),error:i=>(l.value=!1,i.error),position:"top-center"})}).catch(a=>{l.value=!1,w.error(a.error)})}async function Le(e,l,u,d){const a=(i,_)=>new Promise((c,t)=>{const m=setInterval(()=>{T.getOrderPayStatus(i).then(p=>{p.status!=0&&(clearInterval(m),clearInterval(f),c(p))}).catch(p=>{clearInterval(m),clearTimeout(f),t(p)})},4e3),f=setInterval(()=>{_-=1,_<=0&&(clearInterval(m),clearInterval(f),t({error:"支付超时，请重新尝试",code:-408}))},1e3)});return l.value=!0,ye.createOrderPayGateway(u,e).then(i=>{const _=i.expire_time-Math.floor(Date.now()/1e3);w.promise(()=>(setTimeout(()=>{let c=i.redirect;W(c)||(c=`${window.location.origin}`+c),window.open(c,"_blank")},2e3),a(e,_)),{loading:"等待支付中，请勿关闭页面......",success:c=>(xe().initWallet(),setTimeout(()=>{l.value=!1,d(),ie.push({name:"OrderUserPage"})},3e3),c.status==1?"支付成功":"支付取消"),error:c=>(l.value=!1,c.error),position:"top-center"})}).catch(i=>{l.value=!1,w.error(i.error)})}async function et(e,l,u){return T.cancelOrder(e).then(()=>{u(),w.success("订单已取消")}).catch(d=>{w.error(d.error)}).finally(()=>{l.value=!1})}const H=h(),tt=e=>H.value=e,I=h(!1),S=h(!1),at=e=>{S.value=e},st=e=>{I.value=!0,et($.value[e].order_no,I,()=>{const l=[...$.value];l[e].status=2,l[e].status_label="取消订单",$.value=l,S.value=!1})},nt=async(e,l)=>{if(I.value=!0,$.value[e].status!=0&&$.value[e].is_auto){await Ye($.value[e].order_no,I,()=>{$.value[e].status=3,$.value[e].status_label="订单完成",S.value=!1});return}if(l==""){w.error("请选择支付方式"),I.value=!1;return}await Le($.value[e].order_no,I,l,()=>{S.value=!1})},lt=[{id:"订单编号",accessorKey:"order_no",header:"订单编号",cell:({row:e})=>y($e,{text:e.original.order_no,width:20})},{id:"订单类型",accessorKey:"order_type",header:"订单类型",cell:({row:e})=>e.original.order_type_label},{id:"标题",accessorKey:"title",header:"标题",cell:({row:e})=>e.original.title.length==0?"-":e.original.title},{id:"支付方式",accessorKey:"payment_name",header:"支付方式",cell:({row:e})=>e.original.payment_name},{id:"支付金额",accessorKey:"total_amount",header:"支付金额",cell:({row:e})=>y(me,{money:e.original.total_amount},{trigger:()=>y("div",{class:"flex items-center"},[C(e.original.pay_amount),y(de,{icon:"radix-icons:question-mark-circled",class:"size-4 color-red-500"})]),content:()=>{const l=[y("div",{class:"flex items-center"},[y("span","总金额:"),C(e.original.total_amount)])];return e.original.handling_amount>0&&l.push(y("div",{class:"flex items-center"},[y("span","手续费:"),C(e.original.handling_amount)])),e.original.discount_amount>0&&l.push(y("div",{class:"flex items-center"},[y("span","折扣:"),C(e.original.discount_amount)])),y("div",l)}})},{id:"状态",accessorKey:"status",header:"状态",cell:({row:e})=>y(ne,{variant:"outline",class:["dark:text-white text-nowrap",["bg-gray-500","bg-green-500","bg-red-500","bg-yellow-500"][e.original.status]]},{default:()=>e.original.status_label})},{id:"支付时间",accessorKey:"paid_time",header:"支付时间",cell:({row:e})=>e.original.paid_time??"-"},{id:"创建时间",accessorKey:"created_at",header:"创建时间",cell:({row:e})=>e.original.created_at??"-"},{id:"更新时间",accessorKey:"updated_at",header:"更新时间",cell:({row:e})=>e.original.updated_at??"-"},{id:"actions",cell:({row:e})=>y("div",{class:"relative"},y(Qe,{open:S.value,loading:I.value,order:e,payments:H.value??[],"onUpdate:setOpen":at,"onUpdate:cancelRecord":st,"onUpdate:payRecord":nt}))}],ot={sm:["订单编号","标题","支付方式","支付时间","创建时间","更新时间"],md:["订单类型","标题","支付方式","创建时间","更新时间"],lg:["订单类型","标题","更新时间"]},rt={class:"w-full"},Ot=K({__name:"IndexPage",setup(e){const l=h({pageIndex:0,pageSize:10}),u=h({}),{loading:d,tableData:a,totalResultCount:i,totalResultCountTotal:_,filter:c}=Xe(l,u);function t({pageIndex:m,pageSize:f}){return l.value.pageIndex=m,l.value.pageSize=f,{pageIndex:m,pageSize:f}}return ue(()=>{_e.getPayOrderPayment().then(m=>{tt(m)}).catch(m=>{w.error(m.error)})}),(m,f)=>(v(),b("div",rt,[n(s(V),{loading:s(d)},{default:o(()=>[n(s(le),{data:s(a),columns:s(lt),"is-selectable":!1,hiddenFilters:s(ot),pagination:l.value,totalPage:s(i),totalCount:s(_),filters:s(c)??[],onSetPagination:t,onSearch:f[0]||(f[0]=p=>{u.value.value=p})},null,8,["data","columns","hiddenFilters","pagination","totalPage","totalCount","filters"])]),_:1},8,["loading"])]))}});export{Ot as default};
